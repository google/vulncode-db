{% from 'macros/products.html' import print_product_links %}
{% from 'macros/user.html' import print_user %}
{% from 'macros/text_format.html' import print_link, print_cwes, print_formatted %}

{% set vuln_view = vulnerability_details.vulnerability_view %}

{% set commit_hash = vulnerability_details.commit_hash %}
{% set repo_url = vulnerability_details.repo_url %}

<div class="card">
  <div class="card-body">

    {% if edit_mode %}
      <form class="form" method="post" role="form">
      {{ form.hidden_tag() }}
      {{ wtf.form_errors(form, hiddens="only") }}
    {% endif %}

    {% if vuln_view %}
      {% set vcdb_id = vuln_view.id %}

      <div class="navbar-expand-md navbar-light bg-white">
        <div class="collapse navbar-collapse" id="navbarCollapse">
          <ul class="navbar-nav mr-auto"></ul>
          <ul class="navbar-nav mt-2 mt-md-0">
            {# Hiding the "READ" button for now.
            <li class="nav-item">
              <a class="nav-link p-0" href="{{ url_for('vuln.vuln_view', vcdb_id=vuln_view.id) }}"><button type="button" class="btn btn-link btn-tb active">Read</button></a>
            </li>
            #}
            <li class="nav-item">
              {% if edit_mode %}
                <a class="p-0" href="{{ url_for('vuln.vuln_view', vcdb_id=vcdb_id) }}" target="_blank">See original entry</a>
              {% else %}
                {% if vuln_view.vulnerability and vuln_view.state.name in ['NEW', 'NEEDS_IMPROVEMENT', 'READY'] %}
                  <a class="nav-link p-0" href="{{ url_for('profile.edit_proposal', vuln_id=vuln_view.vuln_id) }}"><button type="button" class="btn btn-dark btn-tb">
                    {% if vuln_view.needs_improvement() %}
                      Address feedback
                    {% else %}
                      Edit proposal
                    {% endif %}
                  </button></a>
                  <a class="nav-link p-0" href="{{ url_for('profile.delete_proposal', vuln_id=vuln_view.vuln_id) }}"><button type="button" class="btn btn-danger btn-tb">
                    Delete proposal
                  </button></a>
                {% elif vuln_view.vulnerability and g.user and g.user.is_admin() and vuln_view.state.name == 'ARCHIVED' %}
                  <a class="nav-link p-0" href="{{ url_for('profile.delete_proposal', vuln_id=vuln_view.vuln_id) }}"><button type="button" class="btn btn-danger btn-tb">
                    Delete proposal
                  </button></a>
                {% elif not vuln_view.vulnerability or vuln_view.state.name == 'PUBLISHED' %}
                  {% if vuln_view.master_commit and 'github.com' not in vuln_view.master_commit.commit_link %}
                    <span class="d-inline-block" tabindex="0" data-toggle="tooltip" title="No support for entries without github.com patch links">
                      <button type="button" class="btn btn-grey btn-tb disabled" disabled>Propose changes</button>
                    </span>
                  {% else %}
                    <a class="nav-link p-0" href="{{ url_for('vuln.edit_vuln', vcdb_id=vcdb_id) }}"><button type="button" class="btn btn-dark btn-tb">Propose changes</button></a>
                  {% endif %}
                {% elif g.user.is_admin() and vuln_view.state.name == 'PUBLISHED' %}
                  <a class="nav-link p-0" href="{{ url_for('vuln.edit_vuln', vuln_id=vcdb_id) }}"><button type="button" class="btn btn-danger btn-tb">
                    Delete entry
                  </button></a>
                {% endif %}
              {% endif %}
            </li>
          </ul>
        </div>
      </div>

      <h5 class="card-title d-inline">
        <p class="text-info">
          {% if vuln_view.cve_id %}
            {% if edit_mode %}
              {# Editing the CVE id is disabled for now.
                {{ wtf.form_field(form.cve_id) }}
              #}
            {% else %}
            {% endif %}
            <a href="{{ url_for('vuln.vuln_view', vcdb_id=vuln_view.id) }}" class="text-info">
            <b>{{ vuln_view.id }}</b>
            </a>
            <small>(<a href="https://nvd.nist.gov/vuln/detail/{{ vuln_view.cve_id }}" target="_blank">NVD</a>)</small>
          {% else %}}
          <a href="{{ url_for('vuln.vuln_view', vcdb_id=vuln_view.id) }}" class="text-info">
              ID: <b>{{ vuln_view.id }}</b>
          </a>
          {% endif %}
        </p>
      </h5>

      <h6 class="card-subtitle mb-2 text-muted" title="{{ vuln_view.vulnerability.version }}">{{ vuln_view.date_created }}</h6>

      <div class="row mb-1">
        <div class="col-sm-12">
          {% if edit_mode %}
            {# TODO: Take a look at an adaptive form here
              set comment_rows = form.comment.data.split("\n")|length
            #}
            {{ wtf.form_field(form.comment, rows=6) }}
            <h4>Code location</h4>
            {% include 'vulnerability/forms/code_location.html' %}

            <h5>Products</h5>
            {% include 'vulnerability/forms/product_search.html' %}

            <h5>Links</h5>
            <div class="list-group" data-toggle="fieldset" id="resources-fieldset">
              <ul id="resources" class="list-group">
                {% macro add_resource_entry(num, value='', hidden=False, wtf_field=None) -%}
                  {% set hidden_style='display: none !important' %}
                  {% if not hidden %}{% set hidden_style='' %}{% endif %}
                  <li data-toggle="fieldset-entry" class="list-group-item d-flex justify-content-between align-items-center" style="{{ hidden_style }}">
                    <label for="resources-{{num}}-link" class="col-sm-1 col-form-label"><i class="fa fa-link" style="color: #0000FF" aria-hidden="true"></i></label>
                    <input class="form-control" id="resources-{{num}}-link" name="resources-{{num}}-link" type="text" value="{{value}}" placeholder="Link to a resource">
                    {# Add normal wtf.form rendering here as it also does field error handling etc.
                      {% if wtf_field %}
                        {{ wtf.form_field(wtf_field, form_type='horizontal', horizontal_columns=('lg', 10, 10)) }}
                      {% endif %}
                    #}
                    <span class="col-sm-1">
                      <button type="button" class="close" aria-label="Remove entry" data-toggle="fieldset-remove-row" id="resources-{{num}}-link-remove">
                        <span aria-hidden="true"><i class="fa fa-times" style="color: #FF0000"></i></span>
                      </button>
                    </span>
                  </li>
                {%- endmacro %}
                {# Hidden dummy entry to support removing/adding dynamic fields via JS. #}
                {{ add_resource_entry(num='-1', value='', hidden=True) }}
                {% for l in form.resources %}
                  {{ add_resource_entry(num=loop.index0, value=l.data.link, hidden=False, wtf_field=l.form.link) }}
                {% endfor %}
              </ul>
              <button type="button" data-toggle="fieldset-add-row" class="btn btn-primary btn-sm" data-target="#resources-fieldset">&plus; Add</button>
            </div>

          {% else %}
            <p>
              {% if vuln_view.comment %}
                {{ vuln_view.comment }}
              {% else %}-{% endif %}
            </p>
          {% endif %}
        </div>
      </div>

      {% set master_commit = vuln_view.master_commit %}
      <div class="table-responsive">
        <table class="table table-hover table-dark mb-0">
          <tr>
            <td style="width: 7%"><b>Products</b></td>
            {% set products = vuln_view.products %}

            <td>
              {% if products %}
                {# {{ print_formatted(products, 'products') }} #}
                {{ print_product_links(products) }}
              {% elif master_commit.repo_name %}
                {{ master_commit.repo_name }} (repository)
              {% else %}
                N/A
              {% endif %}
            </td>
          </tr>

          {% if vuln_view.cwes %}
          <tr>
            <td><b>Type</b></td>
            <td style="word-break:break-all;">{{ (print_cwes(vuln_view.cwes)) }}</td>
          </tr>
          {% endif %}

          {# TODO: Decide if we want to display the NVD score.
            {% if vuln_view.score %}
            <tr>
              <td><b>Score</b></td>
              <td>
                {{ '%0.1f' % vuln_view.score }}
              </td>
            </tr>
            {% endif %}
          #}

          <tr>
            <td>
              <b>First patch</b>
              {% if vuln_view.master_commit_date %}
                <br />{{ vuln_view.master_commit_date }}
              {% endif %}
            </td>
            <td style="word-break:break-all;">
              {% if not master_commit and vuln_view.vcdb_exists %}
                <i class="fa fa-times" style="color: #FF0000"></i> - No patch is linked for this entry.
              {% elif not master_commit %}
                <i class="fa fa-times" style="color: #FF0000"></i> - None (likely due to unavailable code)
              {% else %}
                {% set master_commit_link = master_commit.commit_link %}
                <b><a href="{{ master_commit_link }}" class="text-info" target="_blank">{{ master_commit_link }}</a></b><br />
                {% if vuln_view.master_commit_message %}
                  {% set maximum_message_words = 50 %}
                  {% set message_words = vuln_view.master_commit_message.split(' ')  %}
                  {% if message_words | length > maximum_message_words %}
                    "<b>{{ message_words[:maximum_message_words]|join(' ') }}...</b>"
                    {% set remaining_message = message_words[maximum_message_words:]|join(' ')  %}
                    <div>
                      <a href="#" class="text-light" data-toggle="collapse" data-target="#expand_commit_message">
                        <i class="fa fa-caret-square-o-right" aria-hidden="true"></i>
                        More/Less ({{ remaining_message.split("\n")|length }})
                      </a>
                    </div>
                    <div id="expand_commit_message" class="collapse">
                      <b><div style="white-space: pre-wrap;">{{ remaining_message }}</div></b><br />
                    </div>
                  {% else %}
                    "<b>{{ vuln_view.master_commit_message }}</b>"<br />
                  {% endif %}
                  <br />
                  Stats: <b>+{{ vuln_view.master_commit_stats.additions }} lines / -{{ vuln_view.master_commit_stats.deletions }} lines (total: {{ vuln_view.master_commit_stats.total }} lines)</b><br />
                {% endif %}

                {# TODO: add more commit information: message, #modified files and date?
                  <i class="fa fa-check" style="color: #00FF00"></i>
                  <table class="mb-0">
                    <tr>
                      <td class="py-0" style="width: 5%"><b>FOO</b></td>
                      <td class="py-0" style="width: 95%"><b>BAR</b></td>
                    </tr>
                    <tr>
                      <td class="py-0" style="width: 5%"><b>FOO</b></td>
                      <td class="py-0" style="width: 95%"><b>BAR</b></td>
                    </tr>
                  </table>
                #}
              {% endif %}
            </td>
          </tr>

          {% set patch_links = vuln_view.patch_links %}
          {% if patch_links %}
          <tr>
            <td><b>Patches</b></td>
            <td style="word-break:break-all;">{{ print_formatted(vuln_view.patch_links, 'patches') }}</td>
          </tr>
          {% endif %}

          {% set relevant_files = vuln_view.relevant_files %}
          {% if relevant_files %}
          <tr>
            <td><b>Relevant file/s</b></td>
            <td style="word-break:break-all;">{{ (relevant_files and print_formatted(relevant_files, 'relevant-files')) }}</td>
          </tr>
          {% endif %}

          {% set links = vuln_view.link_references %}
          {% if links %}
            <tr>
              <td><b>Links</b></td>
              <td style="word-break:break-all;">{{ (links and print_formatted(links, 'links')) }}</td>
            </tr>
          {% endif %}

         {# TODO: enable code annotation support again once this feature is provided
          <tr>
            <td><b>Annotation</b></td>
            <td>
              {% if not vuln_view.master_commit %}
                <b><p class="text-warning d-inline">Note:</p></b>
                <p class="d-inline">No patch was assigned yet.</p>
              {% elif vuln_view.master_commit.comments|length == 0 %}
                <b><p class="text-warning d-inline">Note:</p></b>
                <p class="d-inline"><b>This entry has not been annotated yet.</b></p>
                {% if can('ANNOTATE', vuln) %}
                Please consider adding data:
                <a href="{{ url_for('vuln.vuln_editor', vcdb_id=vcdb_id) }}">
                <button type="button" class="btn-primary btn-tb">Annotate entry</button>
                </a>
                {% endif %}
              {% elif can('ANNOTATE', vuln) %}
                <a href="{{ url_for('vuln.vuln_editor', vcdb_id=vcdb_id) }}">
                <button type="button" class="btn-primary btn-tb">Edit annotation</button>
                </a>
              {% else %}
                Available
              {% endif %}
            </td>
          </tr>
        #}
            {% set creator = vuln_view.creator %}
            {% if creator %}
            <tr>
              <td><b>Last changed by</b></td>
              <td style="word-break:break-all;">{{ print_user(creator, class="text-info") }}</td>
            </tr>
            {% endif %}
        </table>
      </div>

      {% if vuln_view.resources %}
        <h5>Additional resources</h5>
        <div class="list-group">
          {% for resource_link in vuln_view.resources %}
            <a href="{{ resource_link.link }}" target="_blank" class="list-group-item">{{ resource_link.link }}</a>
          {% endfor %}
        </div>
      {% endif %}

      {% if edit_mode %}
        {{ wtf.form_field(form.submit, button_map={'submit':'primary'}) }}
        </form>
      {% endif %}
    {% else %}
      {# TODO: Deprecated, remove this whole section! #}
      <form action="{{ url_for('vuln.create_vuln', vcdb_id=None) }}" method="post">
        <input type="hidden" name="id" value="{{vcdb_id}}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        {% if commit_link %}
          Commit Link:
          <h5>
            <a href="{{ commit_link }}" target="_blank">{{ commit_link }}</a>
          </h5>
          <input type="hidden" name="commits-0-commit_link" value="{{ commit_link }}">
        {% endif %}
        {% if repo_url and commit_hash %}
          Repository:
          <h5>{{ repo_url }}</h5>
          Commit:
          <h5>{{ commit_hash }}</h5>
          <input type="hidden" name="commits-0-repo_url" value="{{ repo_url }}">
          <input type="hidden" name="commits-0-commit_hash" value="{{ commit_hash }}">
        {% else %}
          <h5>{{ vcdb_id }}</h5>
        {% endif %}
        <div class="alert alert-primary" role="alert">
        No entry for this data found.
        <button type="submit" class="btn btn-link">Create new entry</button>
        </div>
      </form>
    {% endif %}
  </div>
</div>
